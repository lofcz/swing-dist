"use strict";var _interopRequireDefault=require("@babel/runtime-corejs3/helpers/interopRequireDefault"),_Object$defineProperty2=require("@babel/runtime-corejs3/core-js-stable/object/define-property");require("core-js/modules/web.timers"),_Object$defineProperty2(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/define-property")),_defineProperties=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/define-properties")),_getOwnPropertyDescriptors=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors")),_forEach=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each")),_getOwnPropertyDescriptor=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor")),_filter=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/filter")),_getOwnPropertySymbols=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols")),_keys=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/keys")),_indexOf=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/index-of")),_defineProperty3=_interopRequireDefault(require("@babel/runtime-corejs3/helpers/defineProperty")),_includes=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/includes")),_sister=_interopRequireDefault(require("sister")),_hammerjs=_interopRequireDefault(require("hammerjs")),_rebound=_interopRequireDefault(require("rebound")),_prefix=_interopRequireDefault(require("prefix")),_Direction=_interopRequireDefault(require("./Direction")),_utilities=require("./utilities");function ownKeys(a,b){var c=(0,_keys["default"])(a);if(_getOwnPropertySymbols["default"]){var d=(0,_getOwnPropertySymbols["default"])(a);b&&(d=(0,_filter["default"])(d).call(d,function(b){return(0,_getOwnPropertyDescriptor["default"])(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)if(b=null==arguments[c]?{}:arguments[c],c%2){var d;(0,_forEach["default"])(d=ownKeys(Object(b),!0)).call(d,function(c){(0,_defineProperty3["default"])(a,c,b[c])})}else if(_getOwnPropertyDescriptors["default"])(0,_defineProperties["default"])(a,(0,_getOwnPropertyDescriptors["default"])(b));else{var e;(0,_forEach["default"])(e=ownKeys(Object(b))).call(e,function(c){(0,_defineProperty2["default"])(a,c,(0,_getOwnPropertyDescriptor["default"])(b,c))})}return a}var slowRafIE9=function(a){window.setInterval(a,25)},raf=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||slowRafIE9,computeDirection=function(a,b,c){var e,d=Math.abs,f=d(a)>d(b);return e=f?0>a?_Direction["default"].LEFT:_Direction["default"].RIGHT:0>b?_Direction["default"].UP:_Direction["default"].DOWN,(0,_includes["default"])(c).call(c,e)?e:_Direction["default"].INVALID},computeHammerDirections=function(a){return a.vertical&&a.lateral?_hammerjs["default"].DIRECTION_ALL:a.vertical?_hammerjs["default"].DIRECTION_VERTICAL:a.lateral?_hammerjs["default"].DIRECTION_HORIZONTAL:_hammerjs["default"].DIRECTION_NONE},Card=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=function(a){return a.lateral&&!a.vertical?function(a){f=a.deltaX}:a.vertical&&!a.lateral?function(a){f=a.deltaX}:function(a){f=a.deltaX,g=a.deltaY}},z=function(){d={},e=Card.makeConfig(a.getConfig()),i=(0,_sister["default"])(),r=a.getSpringSystem(),s=r.createSpring(250,10),t=r.createSpring(500,20),l={},m={coordinateX:0,coordinateY:0},n=0,o=0,u={},u[_Direction["default"].LEFT]="throwoutleft",u[_Direction["default"].RIGHT]="throwoutright",u[_Direction["default"].UP]="throwoutup",u[_Direction["default"].DOWN]="throwoutdown",s.setRestSpeedThreshold(.05),s.setRestDisplacementThreshold(.05),t.setRestSpeedThreshold(.05),t.setRestDisplacementThreshold(.05),v=e.throwOutDistance(e.minThrowOutDistance,e.maxThrowOutDistance),p=new _hammerjs["default"].Manager(b,{recognizers:[[_hammerjs["default"].Pan,{direction:computeHammerDirections(e),threshold:2}]]}),c?Card.prependToParent(b):Card.appendToParent(b),i.on("panstart",function(){Card.appendToParent(b),i.trigger("dragstart",{target:b}),f=0,g=0,j=!0,function a(){j&&(h(),raf(a))}()}),x=y(e),i.on("panmove",x),i.on("panend",function(a){j=!1;var c=m.coordinateX+a.deltaX,f=m.coordinateY+a.deltaY,g=e.isThrowOut(c,f,b,e.throwOutConfidence(c,f,b)),h=computeDirection(c,f,e.allowedDirections);g&&h!==_Direction["default"].INVALID?d.throwOut(c,f,h):d.throwIn(c,f,h),i.trigger("dragend",{target:b})}),(0,_utilities.isTouchDevice)()?(b.addEventListener("touchstart",function(){e.allowMovement(event,(0,_utilities.isTouchDevice)())&&i.trigger("panstart")}),b.addEventListener("touchend",function(){j&&!k&&i.trigger("dragend",{target:b})}),function(){var a;b.addEventListener("touchstart",function(){a=!0}),b.addEventListener("touchend",function(){a=!1}),global.addEventListener("touchmove",function(b){a&&e.allowMovement(b,(0,_utilities.isTouchDevice)())&&b.preventDefault()})}()):(b.addEventListener("mousedown",function(){i.trigger("panstart")}),b.addEventListener("mouseup",function(){j&&!k&&i.trigger("dragend",{target:b})})),p.on("panstart",function(a){k=!0,i.trigger("panstart",a)}),p.on("panmove",function(a){e.allowMovement(a,(0,_utilities.isTouchDevice)())&&i.trigger("panmove",a)}),p.on("panend",function(a){e.allowMovement(a,(0,_utilities.isTouchDevice)())&&(k=!1,i.trigger("panend",a))}),s.addListener({onSpringAtRest:function onSpringAtRest(){i.trigger("throwinend",{target:b})},onSpringUpdate:function onSpringUpdate(a){var b=a.getCurrentValue(),c=_rebound["default"].MathUtil.mapValueInRange(b,0,1,l.fromX,0),d=_rebound["default"].MathUtil.mapValueInRange(b,0,1,l.fromY,0);q(c,d)}}),t.addListener({onSpringAtRest:function onSpringAtRest(){i.trigger("throwoutend",{target:b})},onSpringUpdate:function onSpringUpdate(a){var b,c,d,e=a.getCurrentValue();l.direction===_Direction["default"].RIGHT||l.direction===_Direction["default"].LEFT?(d=l.direction===_Direction["default"].RIGHT?1:-1,b=_rebound["default"].MathUtil.mapValueInRange(e,0,1,l.fromX,v*d),c=l.fromY):(l.direction===_Direction["default"].UP||l.direction===_Direction["default"].DOWN)&&(d=l.direction===_Direction["default"].DOWN?1:-1,b=l.fromX,c=_rebound["default"].MathUtil.mapValueInRange(e,0,1,l.fromY,v*d)),q(b,c)}}),h=function(){if(f!==n||g!==o){n=f,o=g;var a=m.coordinateX+f,c=m.coordinateY+g,d=e.rotation(a,c,b,e.maxRotation);e.transform(b,a,c,d),i.trigger("dragmove",{offset:a,target:b,throwDirection:computeDirection(a,c,e.allowedDirections),throwOutConfidence:e.throwOutConfidence(a,c,b)})}},q=function(a,c){var d=e.rotation(a,c,b,e.maxRotation);m.coordinateX=a||0,m.coordinateY=c||0,e.transform(b,a,c,d)},w=function(a,c,d,f){if(l.fromX=e.lateral?c:0,l.fromY=e.vertical?d:0,l.direction=f||computeDirection(c,d,e.allowedDirections),a===Card.THROW_IN)Card.appendToParent(b),s.setCurrentValue(0).setAtRest().setEndValue(1),i.trigger("throwin",{target:b,throwDirection:l.direction});else if(a===Card.THROW_OUT)Card.appendToParent(b),t.setCurrentValue(0).setAtRest().setVelocity(e.velocity).setEndValue(1),i.trigger("throwout",{target:b,throwDirection:l.direction}),i.trigger(u[l.direction],{target:b,throwDirection:l.direction});else throw new Error("Invalid throw event.")}};return z(),d.on=i.on,d.off=i.off,d.trigger=i.trigger,d.throwIn=function(a,b,c){w(Card.THROW_IN,a,b,c)},d.throwOut=function(a,b,c){w(Card.THROW_OUT,a,b,c)},d.unbindListeners=function(){p.destroy(),s.destroy(),t.destroy()},d.destroy=function(){d.unbindListeners(),a.destroyCard(d)},d};Card.makeConfig=function(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},b={allowedDirections:[_Direction["default"].RIGHT,_Direction["default"].LEFT,_Direction["default"].UP],allowMovement:function allowMovement(){return!0},isThrowOut:Card.isThrowOut,lateral:!0,maxRotation:20,maxThrowOutDistance:500,minThrowOutDistance:400,rotation:Card.rotation,throwOutConfidence:Card.throwOutConfidence,throwOutDistance:Card.throwOutDistance,transform:Card.transform,velocity:100,vertical:!0};return _objectSpread(_objectSpread({},b),a)},Card.transform=function(a,b,c,d){a.style[(0,_prefix["default"])("transform")]="translate3d(0, 0, 0) translate("+b+"px, "+c+"px) rotate("+d+"deg)"},Card.appendToParent=function(a){var b=a.parentNode,c=(0,_utilities.elementChildren)(b),d=(0,_indexOf["default"])(c).call(c,a),e=d+1!==c.length;return e&&(a.remove(),b.append(a)),e},Card.prependToParent=function(a){var b=a.parentNode;a.remove(),b.insertBefore(a,b.firstChild)},Card.throwOutConfidence=function(a,b,c){var d=Math.min,e=Math.abs,f=d(e(a)/c.offsetWidth,1),g=d(e(b)/c.offsetHeight,1);return Math.max(f,g)},Card.isThrowOut=function(a,b,c,d){return 1===d},Card.throwOutDistance=function(a,b){return Math.floor(Math.random()*(b+1-a))+a},Card.rotation=function(a,b,c,d){var e=Math.min,f=e(Math.max(a/c.offsetWidth,-1),1),g=(0<b?1:-1)*e(Math.abs(b)/100,1);return f*g*d},Card.THROW_IN="in",Card.THROW_OUT="out";var _default=Card;exports["default"]=_default;